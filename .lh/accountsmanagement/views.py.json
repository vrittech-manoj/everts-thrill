{
    "sourceFile": "accountsmanagement/views.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 41,
            "patches": [
                {
                    "date": 1725013363852,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1725013373224,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -275,101 +275,5 @@\n             },\n             status=status.HTTP_200_OK,\n         )\n      \n-    class SendEmailForBookingVerification(APIView):\n-    serializer_class = EmailNumberSerializer\n-\n-    def post(self, request, *args, **kwargs):\n-        serializer = self.serializer_class(data=request.data)\n-        if serializer.is_valid():\n-            email = serializer.validated_data[\"email\"]\n-            try:\n-                book = BookManagement.objects.get(email=email)\n-                print(\"services\",book.services.service_name)\n-            except BookManagement.DoesNotExist:\n-                return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n-\n-            # Construct the verification URL\n-            site_url = 'https://example.com'  # Replace with your actual site URL\n-            verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n-\n-            # Send the confirmation email\n-            subject = 'Booking Verification Email'\n-            sendBookingConfirmationEMail(email, verify_url, subject, book)\n-\n-            return Response({'detail': 'Email verification sent successfully'})\n-        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n-\n-def sendBookingConfirmationEMail(email, verify_url, subject, book):\n-    context = {\n-        'verification_url': verify_url,\n-        'book': book,\n-    }\n-\n-    html_content = render_to_string('booking_confirmation.html', context)\n-\n-    email_from = settings.EMAIL_HOST_USER\n-    recipient_list = [email]\n-    plain_message = \"\"\n-\n-    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n-    \n-\n-class PasswordResetView(generics.GenericAPIView):\n-\n-    def generate_otp(self,user):\n-        # Generate a random 6-digit OTP\n-        # return \"123456\"\n-        user = str(user)\n-        return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n-    \n-    serializer_class = PasswordNumberSerializer\n-    def post(self, request):\n-        serializer = self.serializer_class(data=request.data)\n-        serializer.is_valid(raise_exception=True)\n-        email = serializer.data[\"email\"]\n-        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n-        if user:\n-        \n-            otp = self.generate_otp(user.id)\n-\n-            email_type = \"reset_password\"\n-            \n-            subject = 'LifeQuest OTP'\n-            if '@' in email:\n-                email = user.email\n-                sendPasswordResetMail(email, otp,subject,email_type,user)\n-            else:\n-                SendSms(contact=email,otp=otp,message=subject)\n-          \n-            cache_key = f\"password_reset_otp_{user.id}\"\n-            cache.set(cache_key, otp, timeout=otp_time_expired)\n-\n-            return response.Response(\n-                {\n-                \"message\":\"OTP has been sent to your email address\"\n-                },\n-                status=status.HTTP_200_OK,\n-            )\n-        else:\n-            return response.Response(\n-                {\"message\": \"User doesn't exists\"},\n-                status=status.HTTP_400_BAD_REQUEST,\n-            )\n-\n-def sendPasswordResetMail(email, otp, subject, email_type, user):\n-    password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n-    \n-    if email_type == \"reset_password\":  # Ensure this matches what is passed\n-        context = {\n-            'otp': otp,\n-            'user': user,\n-            'verification_url': 'https://example.com/verify'\n-        }\n-        \n-        password_html_contents = render_to_string('forget_password_get_otp.html', context)\n-    \n-    email_from = settings.EMAIL_HOST_USER\n-    recipient_list = [email]\n-    plain_message = \"\"\n-    send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n+    \n\\ No newline at end of file\n"
                },
                {
                    "date": 1725013524236,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -275,5 +275,101 @@\n             },\n             status=status.HTTP_200_OK,\n         )\n      \n-    \n\\ No newline at end of file\n+    class SendEmailForBookingVerification(APIView):\n+    serializer_class = EmailNumberSerializer\n+\n+    def post(self, request, *args, **kwargs):\n+        serializer = self.serializer_class(data=request.data)\n+        if serializer.is_valid():\n+            email = serializer.validated_data[\"email\"]\n+            try:\n+                book = BookManagement.objects.get(email=email)\n+                print(\"services\",book.services.service_name)\n+            except BookManagement.DoesNotExist:\n+                return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n+\n+            # Construct the verification URL\n+            site_url = 'https://example.com'  # Replace with your actual site URL\n+            verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n+\n+            # Send the confirmation email\n+            subject = 'Booking Verification Email'\n+            sendBookingConfirmationEMail(email, verify_url, subject, book)\n+\n+            return Response({'detail': 'Email verification sent successfully'})\n+        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n+\n+def sendBookingConfirmationEMail(email, verify_url, subject, book):\n+    context = {\n+        'verification_url': verify_url,\n+        'book': book,\n+    }\n+\n+    html_content = render_to_string('booking_confirmation.html', context)\n+\n+    email_from = settings.EMAIL_HOST_USER\n+    recipient_list = [email]\n+    plain_message = \"\"\n+\n+    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n+    \n+\n+class PasswordResetView(generics.GenericAPIView):\n+\n+    def generate_otp(self,user):\n+        # Generate a random 6-digit OTP\n+        # return \"123456\"\n+        user = str(user)\n+        return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n+    \n+    serializer_class = PasswordNumberSerializer\n+    def post(self, request):\n+        serializer = self.serializer_class(data=request.data)\n+        serializer.is_valid(raise_exception=True)\n+        email = serializer.data[\"email\"]\n+        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n+        if user:\n+        \n+            otp = self.generate_otp(user.id)\n+\n+            email_type = \"reset_password\"\n+            \n+            subject = 'LifeQuest OTP'\n+            if '@' in email:\n+                email = user.email\n+                sendPasswordResetMail(email, otp,subject,email_type,user)\n+            else:\n+                SendSms(contact=email,otp=otp,message=subject)\n+          \n+            cache_key = f\"password_reset_otp_{user.id}\"\n+            cache.set(cache_key, otp, timeout=otp_time_expired)\n+\n+            return response.Response(\n+                {\n+                \"message\":\"OTP has been sent to your email address\"\n+                },\n+                status=status.HTTP_200_OK,\n+            )\n+        else:\n+            return response.Response(\n+                {\"message\": \"User doesn't exists\"},\n+                status=status.HTTP_400_BAD_REQUEST,\n+            )\n+\n+def sendPasswordResetMail(email, otp, subject, email_type, user):\n+    password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n+    \n+    if email_type == \"reset_password\":  # Ensure this matches what is passed\n+        context = {\n+            'otp': otp,\n+            'user': user,\n+            'verification_url': 'https://example.com/verify'\n+        }\n+        \n+        password_html_contents = render_to_string('forget_password_get_otp.html', context)\n+    \n+    email_from = settings.EMAIL_HOST_USER\n+    recipient_list = [email]\n+    plain_message = \"\"\n+    send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n"
                },
                {
                    "date": 1725013533578,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -299,77 +299,77 @@\n \n             return Response({'detail': 'Email verification sent successfully'})\n         return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n \n-def sendBookingConfirmationEMail(email, verify_url, subject, book):\n-    context = {\n-        'verification_url': verify_url,\n-        'book': book,\n-    }\n+    def sendBookingConfirmationEMail(email, verify_url, subject, book):\n+        context = {\n+            'verification_url': verify_url,\n+            'book': book,\n+        }\n \n-    html_content = render_to_string('booking_confirmation.html', context)\n+        html_content = render_to_string('booking_confirmation.html', context)\n \n-    email_from = settings.EMAIL_HOST_USER\n-    recipient_list = [email]\n-    plain_message = \"\"\n+        email_from = settings.EMAIL_HOST_USER\n+        recipient_list = [email]\n+        plain_message = \"\"\n \n-    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n-    \n+        send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n+        \n \n-class PasswordResetView(generics.GenericAPIView):\n+    class PasswordResetView(generics.GenericAPIView):\n \n-    def generate_otp(self,user):\n-        # Generate a random 6-digit OTP\n-        # return \"123456\"\n-        user = str(user)\n-        return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n-    \n-    serializer_class = PasswordNumberSerializer\n-    def post(self, request):\n-        serializer = self.serializer_class(data=request.data)\n-        serializer.is_valid(raise_exception=True)\n-        email = serializer.data[\"email\"]\n-        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n-        if user:\n+        def generate_otp(self,user):\n+            # Generate a random 6-digit OTP\n+            # return \"123456\"\n+            user = str(user)\n+            return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n         \n-            otp = self.generate_otp(user.id)\n+        serializer_class = PasswordNumberSerializer\n+        def post(self, request):\n+            serializer = self.serializer_class(data=request.data)\n+            serializer.is_valid(raise_exception=True)\n+            email = serializer.data[\"email\"]\n+            user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n+            if user:\n+            \n+                otp = self.generate_otp(user.id)\n \n-            email_type = \"reset_password\"\n+                email_type = \"reset_password\"\n+                \n+                subject = 'LifeQuest OTP'\n+                if '@' in email:\n+                    email = user.email\n+                    sendPasswordResetMail(email, otp,subject,email_type,user)\n+                else:\n+                    SendSms(contact=email,otp=otp,message=subject)\n             \n-            subject = 'LifeQuest OTP'\n-            if '@' in email:\n-                email = user.email\n-                sendPasswordResetMail(email, otp,subject,email_type,user)\n\\ No newline at end of file\n+                cache_key = f\"password_reset_otp_{user.id}\"\n+                cache.set(cache_key, otp, timeout=otp_time_expired)\n+\n+                return response.Response(\n+                    {\n+                    \"message\":\"OTP has been sent to your email address\"\n+                    },\n+                    status=status.HTTP_200_OK,\n+                )\n             else:\n-                SendSms(contact=email,otp=otp,message=subject)\n-          \n-            cache_key = f\"password_reset_otp_{user.id}\"\n-            cache.set(cache_key, otp, timeout=otp_time_expired)\n+                return response.Response(\n+                    {\"message\": \"User doesn't exists\"},\n+                    status=status.HTTP_400_BAD_REQUEST,\n+                )\n \n-            return response.Response(\n-                {\n-                \"message\":\"OTP has been sent to your email address\"\n-                },\n-                status=status.HTTP_200_OK,\n-            )\n-        else:\n-            return response.Response(\n-                {\"message\": \"User doesn't exists\"},\n-                status=status.HTTP_400_BAD_REQUEST,\n-            )\n-\n-def sendPasswordResetMail(email, otp, subject, email_type, user):\n-    password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n-    \n-    if email_type == \"reset_password\":  # Ensure this matches what is passed\n-        context = {\n-            'otp': otp,\n-            'user': user,\n-            'verification_url': 'https://example.com/verify'\n-        }\n+    def sendPasswordResetMail(email, otp, subject, email_type, user):\n+        password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n         \n-        password_html_contents = render_to_string('forget_password_get_otp.html', context)\n-    \n-    email_from = settings.EMAIL_HOST_USER\n-    recipient_list = [email]\n-    plain_message = \"\"\n-    send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n+        if email_type == \"reset_password\":  # Ensure this matches what is passed\n+            context = {\n+                'otp': otp,\n+                'user': user,\n+                'verification_url': 'https://example.com/verify'\n+            }\n+            \n+            password_html_contents = render_to_string('forget_password_get_otp.html', context)\n+        \n+        email_from = settings.EMAIL_HOST_USER\n+        recipient_list = [email]\n+        plain_message = \"\"\n+        send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n"
                },
                {
                    "date": 1725013559975,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -276,30 +276,30 @@\n             status=status.HTTP_200_OK,\n         )\n      \n     class SendEmailForBookingVerification(APIView):\n-    serializer_class = EmailNumberSerializer\n+        serializer_class = EmailNumberSerializer\n \n-    def post(self, request, *args, **kwargs):\n-        serializer = self.serializer_class(data=request.data)\n-        if serializer.is_valid():\n-            email = serializer.validated_data[\"email\"]\n-            try:\n-                book = BookManagement.objects.get(email=email)\n-                print(\"services\",book.services.service_name)\n-            except BookManagement.DoesNotExist:\n-                return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n+        def post(self, request, *args, **kwargs):\n+            serializer = self.serializer_class(data=request.data)\n+            if serializer.is_valid():\n+                email = serializer.validated_data[\"email\"]\n+                try:\n+                    book = BookManagement.objects.get(email=email)\n+                    print(\"services\",book.services.service_name)\n+                except BookManagement.DoesNotExist:\n+                    return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n \n-            # Construct the verification URL\n-            site_url = 'https://example.com'  # Replace with your actual site URL\n-            verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n+                # Construct the verification URL\n+                site_url = 'https://example.com'  # Replace with your actual site URL\n+                verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n \n-            # Send the confirmation email\n-            subject = 'Booking Verification Email'\n-            sendBookingConfirmationEMail(email, verify_url, subject, book)\n+                # Send the confirmation email\n+                subject = 'Booking Verification Email'\n+                sendBookingConfirmationEMail(email, verify_url, subject, book)\n \n-            return Response({'detail': 'Email verification sent successfully'})\n-        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n+                return Response({'detail': 'Email verification sent successfully'})\n+            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n \n     def sendBookingConfirmationEMail(email, verify_url, subject, book):\n         context = {\n             'verification_url': verify_url,\n"
                },
                {
                    "date": 1725013570473,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -299,65 +299,65 @@\n \n                 return Response({'detail': 'Email verification sent successfully'})\n             return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n \n-    def sendBookingConfirmationEMail(email, verify_url, subject, book):\n-        context = {\n-            'verification_url': verify_url,\n-            'book': book,\n-        }\n+        def sendBookingConfirmationEMail(email, verify_url, subject, book):\n+            context = {\n+                'verification_url': verify_url,\n+                'book': book,\n+            }\n \n-        html_content = render_to_string('booking_confirmation.html', context)\n+            html_content = render_to_string('booking_confirmation.html', context)\n \n-        email_from = settings.EMAIL_HOST_USER\n-        recipient_list = [email]\n-        plain_message = \"\"\n+            email_from = settings.EMAIL_HOST_USER\n+            recipient_list = [email]\n+            plain_message = \"\"\n \n-        send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n-        \n+            send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n+            \n \n-    class PasswordResetView(generics.GenericAPIView):\n+        class PasswordResetView(generics.GenericAPIView):\n \n-        def generate_otp(self,user):\n-            # Generate a random 6-digit OTP\n-            # return \"123456\"\n-            user = str(user)\n-            return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n-        \n-        serializer_class = PasswordNumberSerializer\n-        def post(self, request):\n-            serializer = self.serializer_class(data=request.data)\n-            serializer.is_valid(raise_exception=True)\n-            email = serializer.data[\"email\"]\n-            user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n-            if user:\n+            def generate_otp(self,user):\n+                # Generate a random 6-digit OTP\n+                # return \"123456\"\n+                user = str(user)\n+                return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n             \n-                otp = self.generate_otp(user.id)\n+            serializer_class = PasswordNumberSerializer\n+            def post(self, request):\n+                serializer = self.serializer_class(data=request.data)\n+                serializer.is_valid(raise_exception=True)\n+                email = serializer.data[\"email\"]\n+                user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n+                if user:\n+                \n+                    otp = self.generate_otp(user.id)\n \n-                email_type = \"reset_password\"\n+                    email_type = \"reset_password\"\n+                    \n+                    subject = 'LifeQuest OTP'\n+                    if '@' in email:\n+                        email = user.email\n+                        sendPasswordResetMail(email, otp,subject,email_type,user)\n+                    else:\n+                        SendSms(contact=email,otp=otp,message=subject)\n                 \n-                subject = 'LifeQuest OTP'\n-                if '@' in email:\n-                    email = user.email\n-                    sendPasswordResetMail(email, otp,subject,email_type,user)\n+                    cache_key = f\"password_reset_otp_{user.id}\"\n+                    cache.set(cache_key, otp, timeout=otp_time_expired)\n+\n+                    return response.Response(\n+                        {\n+                        \"message\":\"OTP has been sent to your email address\"\n+                        },\n+                        status=status.HTTP_200_OK,\n+                    )\n                 else:\n-                    SendSms(contact=email,otp=otp,message=subject)\n-            \n-                cache_key = f\"password_reset_otp_{user.id}\"\n-                cache.set(cache_key, otp, timeout=otp_time_expired)\n+                    return response.Response(\n+                        {\"message\": \"User doesn't exists\"},\n+                        status=status.HTTP_400_BAD_REQUEST,\n+                    )\n \n-                return response.Response(\n-                    {\n-                    \"message\":\"OTP has been sent to your email address\"\n-                    },\n-                    status=status.HTTP_200_OK,\n-                )\n-            else:\n-                return response.Response(\n-                    {\"message\": \"User doesn't exists\"},\n-                    status=status.HTTP_400_BAD_REQUEST,\n-                )\n-\n     def sendPasswordResetMail(email, otp, subject, email_type, user):\n         password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n         \n         if email_type == \"reset_password\":  # Ensure this matches what is passed\n"
                },
                {
                    "date": 1725013653383,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,7 @@\n from django.shortcuts import render\n from rest_framework import generics, status, viewsets, response\n-from .serializers import EmailNumberSerializer, CustomPasswordResetSerializer, TokenValidationSerializer,ContactMeSerializer,EmailResetSerializer,EmailChangeGetOtpSerializer\n+from .serializers import EmailNumberSerializer,PasswordNumberSerializer, CustomPasswordResetSerializer, TokenValidationSerializer,ContactMeSerializer,EmailResetSerializer,EmailChangeGetOtpSerializer\n from accounts.models import CustomUser\n from django.utils.http import urlsafe_base64_encode\n from django.utils.encoding import force_bytes\n from django.contrib.auth.tokens import PasswordResetTokenGenerator\n@@ -356,20 +356,20 @@\n                         {\"message\": \"User doesn't exists\"},\n                         status=status.HTTP_400_BAD_REQUEST,\n                     )\n \n-    def sendPasswordResetMail(email, otp, subject, email_type, user):\n-        password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n-        \n-        if email_type == \"reset_password\":  # Ensure this matches what is passed\n-            context = {\n-                'otp': otp,\n-                'user': user,\n-                'verification_url': 'https://example.com/verify'\n-            }\n+        def sendPasswordResetMail(email, otp, subject, email_type, user):\n+            password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n             \n-            password_html_contents = render_to_string('forget_password_get_otp.html', context)\n-        \n-        email_from = settings.EMAIL_HOST_USER\n-        recipient_list = [email]\n\\ No newline at end of file\n-        plain_message = \"\"\n-        send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n+            if email_type == \"reset_password\":  # Ensure this matches what is passed\n+                context = {\n+                    'otp': otp,\n+                    'user': user,\n+                    'verification_url': 'https://example.com/verify'\n+                }\n+                \n+                password_html_contents = render_to_string('forget_password_get_otp.html', context)\n+            \n+            email_from = settings.EMAIL_HOST_USER\n+            recipient_list = [email]\n+            plain_message = \"\"\n+            send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n"
                },
                {
                    "date": 1725013669342,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -198,9 +198,9 @@\n         reset_verification = \"verification\"\n         sendMail(email,verify_url,subject,reset_verification)\n \n         return Response({\n-            'detail': 'Email verificatio'})\n+            'detail': 'Email verification'})\n \n def sendMail(email, reset_url,subject,reset_verification):\n     if reset_verification == \"verification\":\n         body = f\"\"\"<body>\n"
                },
                {
                    "date": 1725013719690,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,8 +8,9 @@\n from django.urls import reverse\n from django.conf import settings\n from django.core.mail import send_mail\n from django.contrib.auth.hashers import check_password\n+from django.template.loader import render_to_string\n \n \n from rest_framework.views import APIView\n from rest_framework.response import Response\n"
                },
                {
                    "date": 1725013725048,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,8 +9,9 @@\n from django.conf import settings\n from django.core.mail import send_mail\n from django.contrib.auth.hashers import check_password\n from django.template.loader import render_to_string\n+from \n \n \n from rest_framework.views import APIView\n from rest_framework.response import Response\n"
                },
                {
                    "date": 1725013733633,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,9 +9,9 @@\n from django.conf import settings\n from django.core.mail import send_mail\n from django.contrib.auth.hashers import check_password\n from django.template.loader import render_to_string\n-from \n+from booking.models import B\n \n \n from rest_framework.views import APIView\n from rest_framework.response import Response\n"
                },
                {
                    "date": 1725013807816,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,9 +9,9 @@\n from django.conf import settings\n from django.core.mail import send_mail\n from django.contrib.auth.hashers import check_password\n from django.template.loader import render_to_string\n-from booking.models import B\n+from booking.models import DestinationBook\n \n \n from rest_framework.views import APIView\n from rest_framework.response import Response\n@@ -285,9 +285,9 @@\n             serializer = self.serializer_class(data=request.data)\n             if serializer.is_valid():\n                 email = serializer.validated_data[\"email\"]\n                 try:\n-                    book = BookManagement.objects.get(email=email)\n+                    book = DestinationBook.objects.get(email=email)\n                     print(\"services\",book.services.service_name)\n                 except BookManagement.DoesNotExist:\n                     return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n \n"
                },
                {
                    "date": 1725013819181,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -287,9 +287,9 @@\n                 email = serializer.validated_data[\"email\"]\n                 try:\n                     book = DestinationBook.objects.get(email=email)\n                     print(\"services\",book.services.service_name)\n-                except BookManagement.DoesNotExist:\n+                except DestinationBook.DoesNotExist:\n                     return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n \n                 # Construct the verification URL\n                 site_url = 'https://example.com'  # Replace with your actual site URL\n"
                },
                {
                    "date": 1725013832535,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -358,9 +358,9 @@\n                         {\"message\": \"User doesn't exists\"},\n                         status=status.HTTP_400_BAD_REQUEST,\n                     )\n \n-        def sendPasswordResetMail(email, otp, subject, email_type, user):\n+    def sendPasswordResetMail(email, otp, subject, email_type, user):\n             password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n             \n             if email_type == \"reset_password\":  # Ensure this matches what is passed\n                 context = {\n"
                },
                {
                    "date": 1725013838534,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -358,9 +358,9 @@\n                         {\"message\": \"User doesn't exists\"},\n                         status=status.HTTP_400_BAD_REQUEST,\n                     )\n \n-    def sendPasswordResetMail(email, otp, subject, email_type, user):\n+def sendPasswordResetMail(email, otp, subject, email_type, user):\n             password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n             \n             if email_type == \"reset_password\":  # Ensure this matches what is passed\n                 context = {\n"
                },
                {
                    "date": 1725013844442,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -359,11 +359,11 @@\n                         status=status.HTTP_400_BAD_REQUEST,\n                     )\n \n def sendPasswordResetMail(email, otp, subject, email_type, user):\n-            password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n+    password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n             \n-            if email_type == \"reset_password\":  # Ensure this matches what is passed\n+        if email_type == \"reset_password\":  # Ensure this matches what is passed\n                 context = {\n                     'otp': otp,\n                     'user': user,\n                     'verification_url': 'https://example.com/verify'\n"
                },
                {
                    "date": 1725013850725,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -370,8 +370,8 @@\n                 }\n                 \n                 password_html_contents = render_to_string('forget_password_get_otp.html', context)\n             \n-            email_from = settings.EMAIL_HOST_USER\n-            recipient_list = [email]\n+        email_from = settings.EMAIL_HOST_USER\n+        recipient_list = [email]\n             plain_message = \"\"\n             send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n"
                },
                {
                    "date": 1725013859573,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -361,9 +361,9 @@\n \n def sendPasswordResetMail(email, otp, subject, email_type, user):\n     password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n             \n-        if email_type == \"reset_password\":  # Ensure this matches what is passed\n+    if email_type == \"reset_password\":  # Ensure this matches what is passed\n                 context = {\n                     'otp': otp,\n                     'user': user,\n                     'verification_url': 'https://example.com/verify'\n@@ -372,6 +372,6 @@\n                 password_html_contents = render_to_string('forget_password_get_otp.html', context)\n             \n         email_from = settings.EMAIL_HOST_USER\n         recipient_list = [email]\n-            plain_message = \"\"\n-            send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n+        plain_message = \"\"\n+        send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n"
                },
                {
                    "date": 1725013869058,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -370,8 +370,8 @@\n                 }\n                 \n                 password_html_contents = render_to_string('forget_password_get_otp.html', context)\n             \n-        email_from = settings.EMAIL_HOST_USER\n-        recipient_list = [email]\n-        plain_message = \"\"\n-        send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n+    email_from = settings.EMAIL_HOST_USER\n+    recipient_list = [email]\n+    plain_message = \"\"\n+    send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n"
                },
                {
                    "date": 1725013885162,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -336,9 +336,9 @@\n                     otp = self.generate_otp(user.id)\n \n                     email_type = \"reset_password\"\n                     \n-                    subject = 'LifeQuest OTP'\n+                    subject = 'Everest Thrill O'\n                     if '@' in email:\n                         email = user.email\n                         sendPasswordResetMail(email, otp,subject,email_type,user)\n                     else:\n"
                },
                {
                    "date": 1725013892071,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -336,9 +336,9 @@\n                     otp = self.generate_otp(user.id)\n \n                     email_type = \"reset_password\"\n                     \n-                    subject = 'Everest Thrill O'\n+                    subject = 'Everest Thrill Password Reset OTP'\n                     if '@' in email:\n                         email = user.email\n                         sendPasswordResetMail(email, otp,subject,email_type,user)\n                     else:\n"
                },
                {
                    "date": 1725013903401,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -319,9 +319,9 @@\n \n         class PasswordResetView(generics.GenericAPIView):\n \n             def generate_otp(self,user):\n-                # Generate a random 6-digit OTP\n+                # Generate a random 5-digit OTP\n                 # return \"123456\"\n                 user = str(user)\n                 return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n             \n"
                },
                {
                    "date": 1725013931448,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -320,9 +320,9 @@\n         class PasswordResetView(generics.GenericAPIView):\n \n             def generate_otp(self,user):\n                 # Generate a random 5-digit OTP\n-                # return \"123456\"\n+                # return \"12345\"\n                 user = str(user)\n                 return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n             \n             serializer_class = PasswordNumberSerializer\n@@ -368,9 +368,9 @@\n                     'user': user,\n                     'verification_url': 'https://example.com/verify'\n                 }\n                 \n-                password_html_contents = render_to_string('forget_password_get_otp.html', context)\n+                password_html_contents = render_to_string('reset_password_otp.html', context)\n             \n     email_from = settings.EMAIL_HOST_USER\n     recipient_list = [email]\n     plain_message = \"\"\n"
                },
                {
                    "date": 1725013988651,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -301,23 +301,20 @@\n \n                 return Response({'detail': 'Email verification sent successfully'})\n             return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n \n-        def sendBookingConfirmationEMail(email, verify_url, subject, book):\n-            context = {\n-                'verification_url': verify_url,\n-                'book': book,\n-            }\n+def sendBookingConfirmationEMail(email, verify_url, subject, book):\n+    context = {\n+        'verification_url': verify_url,\n+        'book': book,\n+    \n+    html_content = render_to_string('booking_confirmation.html', context\n+    email_from = settings.EMAIL_HOST_USER\n+    recipient_list = [email]\n+    plain_message = \"\n+    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n+    \n \n-            html_content = render_to_string('booking_confirmation.html', context)\n-\n-            email_from = settings.EMAIL_HOST_USER\n-            recipient_list = [email]\n-            plain_message = \"\"\n-\n-            send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n-            \n-\n         class PasswordResetView(generics.GenericAPIView):\n \n             def generate_otp(self,user):\n                 # Generate a random 5-digit OTP\n"
                },
                {
                    "date": 1725014009767,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -300,8 +300,9 @@\n                 sendBookingConfirmationEMail(email, verify_url, subject, book)\n \n                 return Response({'detail': 'Email verification sent successfully'})\n             return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n+        \n \n def sendBookingConfirmationEMail(email, verify_url, subject, book):\n     context = {\n         'verification_url': verify_url,\n"
                },
                {
                    "date": 1725014017212,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,9 +306,9 @@\n def sendBookingConfirmationEMail(email, verify_url, subject, book):\n     context = {\n         'verification_url': verify_url,\n         'book': book,\n-    \n+    }\n     html_content = render_to_string('booking_confirmation.html', context\n     email_from = settings.EMAIL_HOST_USER\n     recipient_list = [email]\n     plain_message = \"\n"
                },
                {
                    "date": 1725014037826,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -307,9 +307,9 @@\n     context = {\n         'verification_url': verify_url,\n         'book': book,\n     }\n-    html_content = render_to_string('booking_confirmation.html', context\n+    html_content = render_to_string('booking_confirmation.html', context)\n     email_from = settings.EMAIL_HOST_USER\n     recipient_list = [email]\n     plain_message = \"\n     send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n"
                },
                {
                    "date": 1725014049783,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -307,13 +307,13 @@\n     context = {\n         'verification_url': verify_url,\n         'book': book,\n     }\n-    html_content = render_to_string('booking_confirmation.html', context)\n+    html_content = render_to_string('booking_confirmation.html', context\n     email_from = settings.EMAIL_HOST_USER\n     recipient_list = [email]\n     plain_message = \"\n-    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n+    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content))\n     \n \n         class PasswordResetView(generics.GenericAPIView):\n \n"
                },
                {
                    "date": 1725014056295,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -311,9 +311,9 @@\n     html_content = render_to_string('booking_confirmation.html', context\n     email_from = settings.EMAIL_HOST_USER\n     recipient_list = [email]\n     plain_message = \"\n-    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content))\n+    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n     \n \n         class PasswordResetView(generics.GenericAPIView):\n \n"
                },
                {
                    "date": 1725014069944,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -307,12 +307,12 @@\n     context = {\n         'verification_url': verify_url,\n         'book': book,\n     }\n-    html_content = render_to_string('booking_confirmation.html', context\n+    html_content = render_to_string('booking_confirmation.html', context)\n     email_from = settings.EMAIL_HOST_USER\n     recipient_list = [email]\n-    plain_message = \"\n+    plain_message = \"\"\n     send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n     \n \n         class PasswordResetView(generics.GenericAPIView):\n"
                },
                {
                    "date": 1725014084063,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -314,9 +314,9 @@\n     plain_message = \"\"\n     send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n     \n \n-        class PasswordResetView(generics.GenericAPIView):\n+    class PasswordResetView(generics.GenericAPIView):\n \n             def generate_otp(self,user):\n                 # Generate a random 5-digit OTP\n                 # return \"12345\"\n"
                },
                {
                    "date": 1725014120924,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -298,9 +298,9 @@\n                 # Send the confirmation email\n                 subject = 'Booking Verification Email'\n                 sendBookingConfirmationEMail(email, verify_url, subject, book)\n \n-                return Response({'detail': 'Email verification sent successfully'})\n+                return Response({'detail': 'Email for Booking confirmation verification sent successfully'})\n             return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n         \n \n def sendBookingConfirmationEMail(email, verify_url, subject, book):\n"
                },
                {
                    "date": 1725014390361,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,375 @@\n+from django.shortcuts import render\n+from rest_framework import generics, status, viewsets, response\n+from .serializers import EmailNumberSerializer,PasswordNumberSerializer, CustomPasswordResetSerializer, TokenValidationSerializer,ContactMeSerializer,EmailResetSerializer,EmailChangeGetOtpSerializer\n+from accounts.models import CustomUser\n+from django.utils.http import urlsafe_base64_encode\n+from django.utils.encoding import force_bytes\n+from django.contrib.auth.tokens import PasswordResetTokenGenerator\n+from django.urls import reverse\n+from django.conf import settings\n+from django.core.mail import send_mail\n+from django.contrib.auth.hashers import check_password\n+from django.template.loader import render_to_string\n+from booking.models import DestinationBook\n+\n+\n+from rest_framework.views import APIView\n+from rest_framework.response import Response\n+from rest_framework import status\n+from rest_framework_simplejwt.tokens import RefreshToken\n+from .sms_sender import SendSms,ContactMe\n+from django.db.models import Q\n+from django.core.cache import cache\n+\n+import random\n+import string\n+\n+otp_time_expired = 1200\n+site_f  = \"https://lims.dftqc.gov.np\" #http://localhost:4200\"#\"https://dev-lims.netlify.app\"#\"https://lims.dftqc.gov.np\"\n+\n+class EmailCheckView(generics.GenericAPIView):\n+\n+    def generate_otp(self,user):\n+        # Generate a random 6-digit OTP\n+        return '987654'\n+        user = str(user)\n+        return user[0]+''.join(random.choices(string.digits, k=4)) + user[-1]\n+    \n+    serializer_class = EmailNumberSerializer\n+    def post(self, request):\n+        serializer = self.serializer_class(data=request.data)\n+        serializer.is_valid(raise_exception=True)\n+        email = serializer.data[\"email\"]\n+        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n+        if user:\n+        \n+            otp = self.generate_otp(user.id)\n+\n+            reset_verification = \"reset_password\"\n+            subject = 'lead-management OTP'\n+            if '@' in email:\n+                email = user.email\n+                sendMail(email, otp,subject,reset_verification)\n+            else:\n+                SendSms(contact=email,otp=otp,message=subject)\n+          \n+            cache_key = f\"password_reset_otp_{user.id}\"\n+        \n+            cache.set(cache_key, otp, timeout=otp_time_expired)\n+\n+            return response.Response(\n+                {\n+                \"message\": \"otp has been sent to your email address\"\n+                },\n+                status=status.HTTP_200_OK,\n+            )\n+        else:\n+            return response.Response(\n+                {\"message\": \"User doesn't exists\"},\n+                status=status.HTTP_400_BAD_REQUEST,\n+            )\n+        \n+class EmailChangeGetOtpView(generics.GenericAPIView):\n+    def generate_otp(self,user):\n+        # Generate a random 6-digit OTP\n+        return \"123456\"\n+        user = str(user)\n+        return user[0]+''.join(random.choices(string.digits, k=4)) + user[-1]\n+    \n+    serializer_class = EmailChangeGetOtpSerializer\n+    def post(self, request):\n+        serializer = self.serializer_class(data=request.data)\n+        serializer.is_valid(raise_exception=True)\n+        email = serializer.data[\"email\"]\n+        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n+        if user:\n+        \n+            otp = self.generate_otp(user.id)\n+\n+            reset_verification = \"reset_email\"\n+            subject = 'Pacific OTP'\n+            if '@' in email:\n+                email = user.email\n+                sendMail(serializer.data[\"second_email\"], otp,subject,reset_verification)\n+            else:\n+                SendSms(contact=email,otp=otp,message=subject)\n+          \n+            cache_key = f\"email_reset_otp_{user.id}\"\n+            cache.set(cache_key, otp, timeout=otp_time_expired)\n+\n+            return response.Response(\n+                {\n+                \"message\": f\"otp has been sent to your email address {serializer.data['second_email']} \"\n+                },\n+                status=status.HTTP_200_OK,\n+            )\n+        else:\n+            return response.Response(\n+                {\"message\": \"User doesn't exists\"},\n+                status=status.HTTP_400_BAD_REQUEST,\n+            )\n+\n+class CustomPasswordResetView(generics.GenericAPIView):\n+    serializer_class = CustomPasswordResetSerializer\n+    \n+    def post(self, request, *args, **kwargs):\n+        serializer = self.serializer_class(data=request.data, context={\"kwargs\":kwargs})\n+        serializer.is_valid(raise_exception=True)\n+     \n+        user = CustomUser.objects.get(Q(email = serializer.data.get('email')) | Q(phone = serializer.data.get('email')))\n+        if serializer.validated_data.get('token_validate') == True:\n+            user.password = serializer.data.get('password')\n+            user.save()\n+            message = \"Password Reset Complete\"\n+            stat = status.HTTP_200_OK\n+            print(\" password save \")\n+        else:\n+            message = \"Password Reset not Completed\"\n+            stat = status.HTTP_400_BAD_REQUEST\n+            print(\"password not save\")\n+\n+        return response.Response(\n+            {\"message\": message},\n+            status=stat,\n+        )\n+\n+class EmailResetView(generics.GenericAPIView):\n+    serializer_class = EmailResetSerializer\n+    \n+    def post(self, request, *args, **kwargs):\n+        serializer = self.serializer_class(data=request.data, context={\"kwargs\":kwargs})\n+        serializer.is_valid(raise_exception=True)\n+     \n+        user = CustomUser.objects.get(Q(email = serializer.data.get('email')))\n+        if not check_password(serializer.data.get('password'),user.password):\n+            message = \"password does not match\"\n+            stat = status.HTTP_200_OK\n+        if serializer.validated_data.get('token_validate') == True:\n+            print(\"validate  data\")\n+            user.email = serializer.data.get('second_email')\n+            user.save()\n+            message = \"Email Reset Complete\"\n+            stat = status.HTTP_200_OK\n+            print(\" Email Reset save \")\n+        else:\n+            message = \"Email Can Not reset\"\n+            stat = status.HTTP_400_BAD_REQUEST\n+            print(\"Email Reset not save\")\n+\n+        return response.Response(\n+            {\"message\": message},\n+            status=stat,\n+        )\n+    \n+\n+class VerifyUserPasswordToken(generics.GenericAPIView):\n+    serializer_class = TokenValidationSerializer\n+    \n+    def post(self, request, *args, **kwargs):\n+        serializer = self.serializer_class(data=request.data, context={\"kwargs\":kwargs})\n+        serializer.is_valid(raise_exception=True)\n+        \n+        return response.Response(\n+            {\"message\": \"Your Token is Validate\",\n+             'data' : serializer.data,\n+            },\n+            status=status.HTTP_200_OK,\n+        )\n+\n+\n+class SendEmailVerificationLink(APIView):\n+    \n+    def post(self, request, *args, **kwargs):\n+        email = request.data.get('email')\n+        user = CustomUser.objects.filter(email=email).first()\n+\n+        try:\n+            user = CustomUser.objects.get(email=email)\n+        except CustomUser.DoesNotExist:\n+            return Response({\n+                'detail': 'User with this email does not exist.',\n+            }, status=status.HTTP_400_BAD_REQUEST)\n+\n+        encoded_pk = urlsafe_base64_encode(force_bytes(user.pk))\n+        token = PasswordResetTokenGenerator().make_token(user)\n+\n+        # Send the token via email\n+        subject = 'Email Verification Token'\n+        verify_url = f\"{site_f}/user-verification-success?pk={encoded_pk}&token={token}\"\n+        subject = 'Email Verification Link '\n+        reset_verification = \"verification\"\n+        sendMail(email,verify_url,subject,reset_verification)\n+\n+        return Response({\n+            'detail': 'Email verification'})\n+\n+def sendMail(email, reset_url,subject,reset_verification):\n+    if reset_verification == \"verification\":\n+        body = f\"\"\"<body>\n+            <table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"max-width: 600px; font-family: Poppins; background: whitesmoke; padding: 20px; border-radius: 6px;\">\n+                <tr>\n+                    <td align=\"center\" bgcolor=\"#FFFFFF\" style=\"padding: 20px;\">\n+                        <img src=\"https://lead-management.com.np/assets/logo-Ds_vvW8g.png\" alt=\"\" width=\"132\" style=\"display: block; margin: 0 auto;\">\n+                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">lead-management</p>\n+                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">Please verify your account</p>\n+                        <p style=\"text-align: center; font-weight: 400;\">Click the button below to verify your account.</p>\n+                        <a href=\"{reset_url}\" style=\"text-decoration: none; background: #0B53A7; color: #FFFFFF; padding: 10px 20px; border-radius: 3px; display: inline-block; margin-top: 15px;\">Verify Your Account</a>\n+                        <p style=\"text-align: center; margin-top: 20px;\">Please visit <a href=\"https://lead-management.com.np/\" style=\"text-decoration: none; color: #0B53A7; font-weight: 600;\">https://lead-management.com.np/</a> for any enquiries.</p>\n+                        <p style=\"margin: 0; text-align: center;\"><span style=\"font-weight: 600;\">Tel:</span>+977 97798000000</p>\n+                        <p style=\"margin: 0; text-align: center; text-decoration: none;\"><span style=\"font-weight: 600;\">Fax:</span>+97798000000 <span style=\"font-weight: 600; margin-left: 10px;\">E-mail:</span> info@lead-management.com</p>\n+                    </td>\n+                </tr>\n+            </table>\n+        </body>\n+        </html>\"\"\"\n+    else:\n+        body = f\"\"\"<body>\n+            <table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"max-width: 600px; font-family: Poppins; background: whitesmoke; padding: 20px; border-radius: 6px;\">\n+                <tr>\n+                    <td align=\"center\" bgcolor=\"#FFFFFF\" style=\"padding: 20px;\">\n+                        <img src=\"https://lead-management.com.np/assets/logo-Ds_vvW8g.png\" alt=\"\" width=\"132\" style=\"display: block; margin: 0 auto;\">\n+                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">lead-management</p>\n+                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">Please change your Password</p>\n+                        <p style=\"text-align: center; font-weight: 400;\">Your OTP code to reset password is</p>\n+                        <span style=\"text-decoration: none; background: #0B53A7; color: #FFFFFF; padding: 10px 20px; border-radius: 3px; display: inline-block; margin-top: 15px;\">{reset_url}</span>\n+                        <p style=\"text-align: center; margin-top: 20px;\">Please visit <a href=\"https://lead-management.com.np/\" style=\"text-decoration: none; color: #0B53A7; font-weight: 600;\">https://lead-management.com.np</a> for any enquiries.</p>\n+                        <p style=\"margin: 0; text-align: center;\"><span style=\"font-weight: 600;\">Tel:</span> 01-5244366</p>\n+                        <p style=\"margin: 0; text-align: center; text-decoration: none;\"><span style=\"font-weight: 600;\">Phone:</span> +977 9802348565 <span style=\"font-weight: 600; margin-left: 10px;\">E-mail:</span> support@lead-management.com</p>\n+                    </td>\n+                </tr>\n+            </table>\n+        </body>\n+        </html>\"\"\"\n+    html_contents = \"\"\"<!DOCTYPE html>\n+        <html lang=\"en\">\n+        <head>\n+            <meta charset=\"UTF-8\">\n+            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n+            <title>Email Template</title>\n+            <style>\n+                @import url(\"https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap\");\n+            </style>\n+        </head>\"\"\" + body\n+    \n+    email_from = settings.EMAIL_HOST_USER\n+    recipient_list = [email]\n+    plain_message = \"\"\n+    send_mail(subject, plain_message, email_from, recipient_list,html_message=html_contents)\n+\n+\n+class ContactmeView(generics.GenericAPIView):    \n+    serializer_class = ContactMeSerializer\n+    def post(self, request):\n+        serializer = self.serializer_class(data=request.data)\n+        serializer.is_valid(raise_exception=True)\n+\n+        email = serializer.data[\"email\"]\n+        subject = serializer.data.get('subject')\n+        full_name = serializer.data[\"full_name\"]\n+        message = serializer.data[\"message\"]\n+        phone = serializer.data.get(\"phone\")\n+        \n+        ContactMe(email,phone,full_name,subject,message)\n+           \n+        return response.Response(\n+            {\n+            \"message\": \"Email has sent to lead-management Owner, please kindly wait for response\"\n+            },\n+            status=status.HTTP_200_OK,\n+        )\n+     \n+    class SendEmailForBookingVerification(APIView):\n+        serializer_class = EmailNumberSerializer\n+\n+        def post(self, request, *args, **kwargs):\n+            serializer = self.serializer_class(data=request.data)\n+            if serializer.is_valid():\n+                email = serializer.validated_data[\"email\"]\n+                try:\n+                    book = DestinationBook.objects.get(email=email)\n+                    print(\"services\",book.services.service_name)\n+                except DestinationBook.DoesNotExist:\n+                    return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n+\n+                # Construct the verification URL\n+                site_url = 'https://example.com'  # Replace with your actual site URL\n+                verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n+\n+                # Send the confirmation email\n+                subject = 'Booking Verification Email'\n+                sendBookingConfirmationEMail(email, verify_url, subject, book)\n+\n+                return Response({'detail': 'Email for Booking confirmation sent successfully'})\n+            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n+        \n+\n+def sendBookingConfirmationEMail(email, verify_url, subject, book):\n+    context = {\n+        'verification_url': verify_url,\n+        'book': book,\n+    }\n+    html_content = render_to_string('booking_confirmation.html', context)\n+    email_from = settings.EMAIL_HOST_USER\n+    recipient_list = [email]\n+    plain_message = \"\"\n+    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n+    \n+\n+    class PasswordResetView(generics.GenericAPIView):\n+\n+            def generate_otp(self,user):\n+                # Generate a random 5-digit OTP\n+                # return \"12345\"\n+                user = str(user)\n+                return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n+            \n+            serializer_class = PasswordNumberSerializer\n+            def post(self, request):\n+                serializer = self.serializer_class(data=request.data)\n+                serializer.is_valid(raise_exception=True)\n+                email = serializer.data[\"email\"]\n+                user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n+                if user:\n+                \n+                    otp = self.generate_otp(user.id)\n+\n+                    email_type = \"reset_password\"\n+                    \n+                    subject = 'Everest Thrill Password Reset OTP'\n+                    if '@' in email:\n+                        email = user.email\n+                        sendPasswordResetMail(email, otp,subject,email_type,user)\n+                    else:\n+                        SendSms(contact=email,otp=otp,message=subject)\n+                \n+                    cache_key = f\"password_reset_otp_{user.id}\"\n+                    cache.set(cache_key, otp, timeout=otp_time_expired)\n+\n+                    return response.Response(\n+                        {\n+                        \"message\":\"OTP has been sent to your email address\"\n+                        },\n+                        status=status.HTTP_200_OK,\n+                    )\n+                else:\n+                    return response.Response(\n+                        {\"message\": \"User doesn't exists\"},\n+                        status=status.HTTP_400_BAD_REQUEST,\n+                    )\n+\n+def sendPasswordResetMail(email, otp, subject, email_type, user):\n+    password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n+            \n+    if email_type == \"reset_password\":  # Ensure this matches what is passed\n+                context = {\n+                    'otp': otp,\n+                    'user': user,\n+                    'verification_url': 'https://example.com/verify'\n+                }\n+                \n+                password_html_contents = render_to_string('reset_password_otp.html', context)\n+            \n+    email_from = settings.EMAIL_HOST_USER\n+    recipient_list = [email]\n+    plain_message = \"\"\n+    send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n\\ No newline at end of file\n"
                },
                {
                    "date": 1725014589325,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -278,418 +278,50 @@\n             status=status.HTTP_200_OK,\n         )\n      \n     class SendEmailForBookingVerification(APIView):\n-        serializer_class = EmailNumberSerializer\n-\n-        def post(self, request, *args, **kwargs):\n-            serializer = self.serializer_class(data=request.data)\n-            if serializer.is_valid():\n-                email = serializer.validated_data[\"email\"]\n-                try:\n-                    book = DestinationBook.objects.get(email=email)\n-                    print(\"services\",book.services.service_name)\n-                except DestinationBook.DoesNotExist:\n-                    return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n-\n-                # Construct the verification URL\n-                site_url = 'https://example.com'  # Replace with your actual site URL\n-                verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n-\n-                # Send the confirmation email\n-                subject = 'Booking Verification Email'\n-                sendBookingConfirmationEMail(email, verify_url, subject, book)\n-\n-                return Response({'detail': 'Email for Booking confirmation sent successfully'})\n-            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n-        \n-\n-def sendBookingConfirmationEMail(email, verify_url, subject, book):\n-    context = {\n-        'verification_url': verify_url,\n-        'book': book,\n-    }\n-    html_content = render_to_string('booking_confirmation.html', context)\n-    email_from = settings.EMAIL_HOST_USER\n-    recipient_list = [email]\n-    plain_message = \"\"\n-    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n-    \n-\n-    class PasswordResetView(generics.GenericAPIView):\n-\n-            def generate_otp(self,user):\n-                # Generate a random 5-digit OTP\n-                # return \"12345\"\n-                user = str(user)\n-                return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n-            \n-            serializer_class = PasswordNumberSerializer\n-            def post(self, request):\n-                serializer = self.serializer_class(data=request.data)\n-                serializer.is_valid(raise_exception=True)\n-                email = serializer.data[\"email\"]\n-                user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n-                if user:\n-                \n-                    otp = self.generate_otp(user.id)\n-\n-                    email_type = \"reset_password\"\n-                    \n-                    subject = 'Everest Thrill Password Reset OTP'\n-                    if '@' in email:\n-                        email = user.email\n-                        sendPasswordResetMail(email, otp,subject,email_type,user)\n-                    else:\n-                        SendSms(contact=email,otp=otp,message=subject)\n-                \n-                    cache_key = f\"password_reset_otp_{user.id}\"\n-                    cache.set(cache_key, otp, timeout=otp_time_expired)\n-\n-                    return response.Response(\n-                        {\n-                        \"message\":\"OTP has been sent to your email address\"\n-                        },\n-                        status=status.HTTP_200_OK,\n-                    )\n-                else:\n-                    return response.Response(\n-                        {\"message\": \"User doesn't exists\"},\n-                        status=status.HTTP_400_BAD_REQUEST,\n-                    )\n-\n-def sendPasswordResetMail(email, otp, subject, email_type, user):\n-    password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n-            \n-    if email_type == \"reset_password\":  # Ensure this matches what is passed\n-                context = {\n-                    'otp': otp,\n-                    'user': user,\n-                    'verification_url': 'https://example.com/verify'\n-                }\n-                \n-                password_html_contents = render_to_string('reset_password_otp.html', context)\n-            \n-    email_from = settings.EMAIL_HOST_USER\n-    recipient_list = [email]\n-    plain_message = \"\"\n-    send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)\n-from django.shortcuts import render\n-from rest_framework import generics, status, viewsets, response\n-from .serializers import EmailNumberSerializer,PasswordNumberSerializer, CustomPasswordResetSerializer, TokenValidationSerializer,ContactMeSerializer,EmailResetSerializer,EmailChangeGetOtpSerializer\n-from accounts.models import CustomUser\n-from django.utils.http import urlsafe_base64_encode\n-from django.utils.encoding import force_bytes\n-from django.contrib.auth.tokens import PasswordResetTokenGenerator\n-from django.urls import reverse\n-from django.conf import settings\n-from django.core.mail import send_mail\n-from django.contrib.auth.hashers import check_password\n-from django.template.loader import render_to_string\n-from booking.models import DestinationBook\n-\n-\n-from rest_framework.views import APIView\n-from rest_framework.response import Response\n-from rest_framework import status\n-from rest_framework_simplejwt.tokens import RefreshToken\n-from .sms_sender import SendSms,ContactMe\n-from django.db.models import Q\n-from django.core.cache import cache\n-\n-import random\n-import string\n-\n-otp_time_expired = 1200\n-site_f  = \"https://lims.dftqc.gov.np\" #http://localhost:4200\"#\"https://dev-lims.netlify.app\"#\"https://lims.dftqc.gov.np\"\n-\n-class EmailCheckView(generics.GenericAPIView):\n-\n-    def generate_otp(self,user):\n-        # Generate a random 6-digit OTP\n-        return '987654'\n-        user = str(user)\n-        return user[0]+''.join(random.choices(string.digits, k=4)) + user[-1]\n-    \n     serializer_class = EmailNumberSerializer\n-    def post(self, request):\n-        serializer = self.serializer_class(data=request.data)\n-        serializer.is_valid(raise_exception=True)\n-        email = serializer.data[\"email\"]\n-        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n-        if user:\n-        \n-            otp = self.generate_otp(user.id)\n \n-            reset_verification = \"reset_password\"\n-            subject = 'lead-management OTP'\n-            if '@' in email:\n-                email = user.email\n-                sendMail(email, otp,subject,reset_verification)\n-            else:\n-                SendSms(contact=email,otp=otp,message=subject)\n-          \n-            cache_key = f\"password_reset_otp_{user.id}\"\n-        \n-            cache.set(cache_key, otp, timeout=otp_time_expired)\n-\n-            return response.Response(\n-                {\n-                \"message\": \"otp has been sent to your email address\"\n-                },\n-                status=status.HTTP_200_OK,\n-            )\n-        else:\n-            return response.Response(\n-                {\"message\": \"User doesn't exists\"},\n-                status=status.HTTP_400_BAD_REQUEST,\n-            )\n-        \n-class EmailChangeGetOtpView(generics.GenericAPIView):\n-    def generate_otp(self,user):\n-        # Generate a random 6-digit OTP\n-        return \"123456\"\n-        user = str(user)\n-        return user[0]+''.join(random.choices(string.digits, k=4)) + user[-1]\n-    \n-    serializer_class = EmailChangeGetOtpSerializer\n-    def post(self, request):\n-        serializer = self.serializer_class(data=request.data)\n-        serializer.is_valid(raise_exception=True)\n-        email = serializer.data[\"email\"]\n-        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n-        if user:\n-        \n-            otp = self.generate_otp(user.id)\n-\n-            reset_verification = \"reset_email\"\n-            subject = 'Pacific OTP'\n-            if '@' in email:\n-                email = user.email\n-                sendMail(serializer.data[\"second_email\"], otp,subject,reset_verification)\n-            else:\n-                SendSms(contact=email,otp=otp,message=subject)\n-          \n-            cache_key = f\"email_reset_otp_{user.id}\"\n-            cache.set(cache_key, otp, timeout=otp_time_expired)\n-\n-            return response.Response(\n-                {\n-                \"message\": f\"otp has been sent to your email address {serializer.data['second_email']} \"\n-                },\n-                status=status.HTTP_200_OK,\n-            )\n-        else:\n-            return response.Response(\n-                {\"message\": \"User doesn't exists\"},\n-                status=status.HTTP_400_BAD_REQUEST,\n-            )\n-\n-class CustomPasswordResetView(generics.GenericAPIView):\n-    serializer_class = CustomPasswordResetSerializer\n-    \n     def post(self, request, *args, **kwargs):\n-        serializer = self.serializer_class(data=request.data, context={\"kwargs\":kwargs})\n-        serializer.is_valid(raise_exception=True)\n-     \n-        user = CustomUser.objects.get(Q(email = serializer.data.get('email')) | Q(phone = serializer.data.get('email')))\n-        if serializer.validated_data.get('token_validate') == True:\n-            user.password = serializer.data.get('password')\n-            user.save()\n-            message = \"Password Reset Complete\"\n-            stat = status.HTTP_200_OK\n-            print(\" password save \")\n-        else:\n-            message = \"Password Reset not Completed\"\n-            stat = status.HTTP_400_BAD_REQUEST\n-            print(\"password not save\")\n-\n-        return response.Response(\n-            {\"message\": message},\n-            status=stat,\n-        )\n-\n-class EmailResetView(generics.GenericAPIView):\n-    serializer_class = EmailResetSerializer\n-    \n-    def post(self, request, *args, **kwargs):\n-        serializer = self.serializer_class(data=request.data, context={\"kwargs\":kwargs})\n-        serializer.is_valid(raise_exception=True)\n-     \n-        user = CustomUser.objects.get(Q(email = serializer.data.get('email')))\n-        if not check_password(serializer.data.get('password'),user.password):\n-            message = \"password does not match\"\n-            stat = status.HTTP_200_OK\n-        if serializer.validated_data.get('token_validate') == True:\n-            print(\"validate  data\")\n-            user.email = serializer.data.get('second_email')\n-            user.save()\n-            message = \"Email Reset Complete\"\n-            stat = status.HTTP_200_OK\n-            print(\" Email Reset save \")\n-        else:\n-            message = \"Email Can Not reset\"\n-            stat = status.HTTP_400_BAD_REQUEST\n-            print(\"Email Reset not save\")\n-\n-        return response.Response(\n-            {\"message\": message},\n-            status=stat,\n-        )\n-    \n-\n-class VerifyUserPasswordToken(generics.GenericAPIView):\n-    serializer_class = TokenValidationSerializer\n-    \n-    def post(self, request, *args, **kwargs):\n-        serializer = self.serializer_class(data=request.data, context={\"kwargs\":kwargs})\n-        serializer.is_valid(raise_exception=True)\n-        \n-        return response.Response(\n-            {\"message\": \"Your Token is Validate\",\n-             'data' : serializer.data,\n-            },\n-            status=status.HTTP_200_OK,\n-        )\n-\n-\n-class SendEmailVerificationLink(APIView):\n-    \n-    def post(self, request, *args, **kwargs):\n-        email = request.data.get('email')\n-        user = CustomUser.objects.filter(email=email).first()\n-\n-        try:\n-            user = CustomUser.objects.get(email=email)\n-        except CustomUser.DoesNotExist:\n-            return Response({\n-                'detail': 'User with this email does not exist.',\n-            }, status=status.HTTP_400_BAD_REQUEST)\n-\n-        encoded_pk = urlsafe_base64_encode(force_bytes(user.pk))\n-        token = PasswordResetTokenGenerator().make_token(user)\n-\n-        # Send the token via email\n-        subject = 'Email Verification Token'\n-        verify_url = f\"{site_f}/user-verification-success?pk={encoded_pk}&token={token}\"\n-        subject = 'Email Verification Link '\n-        reset_verification = \"verification\"\n-        sendMail(email,verify_url,subject,reset_verification)\n-\n-        return Response({\n-            'detail': 'Email verification'})\n-\n-def sendMail(email, reset_url,subject,reset_verification):\n-    if reset_verification == \"verification\":\n-        body = f\"\"\"<body>\n-            <table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"max-width: 600px; font-family: Poppins; background: whitesmoke; padding: 20px; border-radius: 6px;\">\n-                <tr>\n-                    <td align=\"center\" bgcolor=\"#FFFFFF\" style=\"padding: 20px;\">\n-                        <img src=\"https://lead-management.com.np/assets/logo-Ds_vvW8g.png\" alt=\"\" width=\"132\" style=\"display: block; margin: 0 auto;\">\n-                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">lead-management</p>\n-                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">Please verify your account</p>\n-                        <p style=\"text-align: center; font-weight: 400;\">Click the button below to verify your account.</p>\n-                        <a href=\"{reset_url}\" style=\"text-decoration: none; background: #0B53A7; color: #FFFFFF; padding: 10px 20px; border-radius: 3px; display: inline-block; margin-top: 15px;\">Verify Your Account</a>\n-                        <p style=\"text-align: center; margin-top: 20px;\">Please visit <a href=\"https://lead-management.com.np/\" style=\"text-decoration: none; color: #0B53A7; font-weight: 600;\">https://lead-management.com.np/</a> for any enquiries.</p>\n-                        <p style=\"margin: 0; text-align: center;\"><span style=\"font-weight: 600;\">Tel:</span>+977 97798000000</p>\n-                        <p style=\"margin: 0; text-align: center; text-decoration: none;\"><span style=\"font-weight: 600;\">Fax:</span>+97798000000 <span style=\"font-weight: 600; margin-left: 10px;\">E-mail:</span> info@lead-management.com</p>\n-                    </td>\n-                </tr>\n-            </table>\n-        </body>\n-        </html>\"\"\"\n-    else:\n-        body = f\"\"\"<body>\n-            <table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"max-width: 600px; font-family: Poppins; background: whitesmoke; padding: 20px; border-radius: 6px;\">\n-                <tr>\n-                    <td align=\"center\" bgcolor=\"#FFFFFF\" style=\"padding: 20px;\">\n-                        <img src=\"https://lead-management.com.np/assets/logo-Ds_vvW8g.png\" alt=\"\" width=\"132\" style=\"display: block; margin: 0 auto;\">\n-                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">lead-management</p>\n-                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">Please change your Password</p>\n-                        <p style=\"text-align: center; font-weight: 400;\">Your OTP code to reset password is</p>\n-                        <span style=\"text-decoration: none; background: #0B53A7; color: #FFFFFF; padding: 10px 20px; border-radius: 3px; display: inline-block; margin-top: 15px;\">{reset_url}</span>\n-                        <p style=\"text-align: center; margin-top: 20px;\">Please visit <a href=\"https://lead-management.com.np/\" style=\"text-decoration: none; color: #0B53A7; font-weight: 600;\">https://lead-management.com.np</a> for any enquiries.</p>\n-                        <p style=\"margin: 0; text-align: center;\"><span style=\"font-weight: 600;\">Tel:</span> 01-5244366</p>\n-                        <p style=\"margin: 0; text-align: center; text-decoration: none;\"><span style=\"font-weight: 600;\">Phone:</span> +977 9802348565 <span style=\"font-weight: 600; margin-left: 10px;\">E-mail:</span> support@lead-management.com</p>\n-                    </td>\n-                </tr>\n-            </table>\n-        </body>\n-        </html>\"\"\"\n-    html_contents = \"\"\"<!DOCTYPE html>\n-        <html lang=\"en\">\n-        <head>\n-            <meta charset=\"UTF-8\">\n-            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n-            <title>Email Template</title>\n-            <style>\n-                @import url(\"https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap\");\n-            </style>\n-        </head>\"\"\" + body\n-    \n-    email_from = settings.EMAIL_HOST_USER\n-    recipient_list = [email]\n-    plain_message = \"\"\n-    send_mail(subject, plain_message, email_from, recipient_list,html_message=html_contents)\n-\n-\n-class ContactmeView(generics.GenericAPIView):    \n-    serializer_class = ContactMeSerializer\n-    def post(self, request):\n         serializer = self.serializer_class(data=request.data)\n-        serializer.is_valid(raise_exception=True)\n+        if serializer.is_valid():\n+            email = serializer.validated_data[\"email\"]\n+            try:\n+                book = DestinationBook.objects.get(email=email)\n+                print(\"services\", book.services.service_name)  # Assuming `services` is a ForeignKey\n \n-        email = serializer.data[\"email\"]\n-        subject = serializer.data.get('subject')\n-        full_name = serializer.data[\"full_name\"]\n-        message = serializer.data[\"message\"]\n-        phone = serializer.data.get(\"phone\")\n-        \n-        ContactMe(email,phone,full_name,subject,message)\n-           \n-        return response.Response(\n-            {\n-            \"message\": \"Email has sent to lead-management Owner, please kindly wait for response\"\n-            },\n-            status=status.HTTP_200_OK,\n-        )\n-     \n-    class SendEmailForBookingVerification(APIView):\n-        serializer_class = EmailNumberSerializer\n+            except DestinationBook.DoesNotExist:\n+                return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n \n-        def post(self, request, *args, **kwargs):\n-            serializer = self.serializer_class(data=request.data)\n-            if serializer.is_valid():\n-                email = serializer.validated_data[\"email\"]\n-                try:\n-                    book = DestinationBook.objects.get(email=email)\n-                    print(\"services\",book.services.service_name)\n-                except DestinationBook.DoesNotExist:\n-                    return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n+            # Construct the verification URL\n+            site_url = 'https://example.com'  # Replace with your actual site URL\n+            verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n \n-                # Construct the verification URL\n-                site_url = 'https://example.com'  # Replace with your actual site URL\n-                verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n+            # Send the confirmation email\n+            subject = 'Booking Verification Email'\n+            sendBookingConfirmationEMail(email, verify_url, subject, book)\n \n-                # Send the confirmation email\n-                subject = 'Booking Verification Email'\n-                sendBookingConfirmationEMail(email, verify_url, subject, book)\n-\n-                return Response({'detail': 'Email for Booking confirmation verification sent successfully'})\n-            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n+            return Response({'detail': 'Email for Booking confirmation sent successfully'})\n         \n+        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n \n def sendBookingConfirmationEMail(email, verify_url, subject, book):\n     context = {\n         'verification_url': verify_url,\n-        'book': book,\n+        'recipient_name': 'Admin',  # Or the actual name of the admin or recipient\n+        'contact': book.phone_number,  # Assuming `phone_number` is a field in `DestinationBook`\n+        'activity': book.activity.name,  # Assuming `activity` is a ForeignKey to an `Activity` model\n+        'package': book.package.name,  # Assuming `package` is a ForeignKey to a `Package` model\n+        'destination': book.destination.destination_title,  # Assuming `destination` is a ForeignKey to a `Destination` model\n+        'arrival_date': book.arrival_date.strftime('%d/%m/%Y'),  # Format date as required\n+        'departure_date': book.departure_date.strftime('%d/%m/%Y'),  # Format date as required\n+        'preferred_service_type': book.service_type,  # Assuming `service_type` is a field in `DestinationBook`\n     }\n-    html_content = render_to_string('booking_confirmation.html', context)\n+    html_content = render_to_string('booking_notification_email.html', context)  # Template path\n     email_from = settings.EMAIL_HOST_USER\n     recipient_list = [email]\n     plain_message = \"\"\n     send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n-    \n \n     class PasswordResetView(generics.GenericAPIView):\n \n             def generate_otp(self,user):\n"
                },
                {
                    "date": 1725014602572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -278,32 +278,32 @@\n             status=status.HTTP_200_OK,\n         )\n      \n     class SendEmailForBookingVerification(APIView):\n-    serializer_class = EmailNumberSerializer\n+        serializer_class = EmailNumberSerializer\n \n-    def post(self, request, *args, **kwargs):\n-        serializer = self.serializer_class(data=request.data)\n-        if serializer.is_valid():\n-            email = serializer.validated_data[\"email\"]\n-            try:\n-                book = DestinationBook.objects.get(email=email)\n-                print(\"services\", book.services.service_name)  # Assuming `services` is a ForeignKey\n+        def post(self, request, *args, **kwargs):\n+            serializer = self.serializer_class(data=request.data)\n+            if serializer.is_valid():\n+                email = serializer.validated_data[\"email\"]\n+                try:\n+                    book = DestinationBook.objects.get(email=email)\n+                    print(\"services\", book.services.service_name)  # Assuming `services` is a ForeignKey\n \n-            except DestinationBook.DoesNotExist:\n-                return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n+                except DestinationBook.DoesNotExist:\n+                    return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n \n-            # Construct the verification URL\n-            site_url = 'https://example.com'  # Replace with your actual site URL\n-            verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n+                # Construct the verification URL\n+                site_url = 'https://example.com'  # Replace with your actual site URL\n+                verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n \n-            # Send the confirmation email\n-            subject = 'Booking Verification Email'\n-            sendBookingConfirmationEMail(email, verify_url, subject, book)\n+                # Send the confirmation email\n+                subject = 'Booking Verification Email'\n+                sendBookingConfirmationEMail(email, verify_url, subject, book)\n \n-            return Response({'detail': 'Email for Booking confirmation sent successfully'})\n-        \n-        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n+                return Response({'detail': 'Email for Booking confirmation sent successfully'})\n+            \n+            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n \n def sendBookingConfirmationEMail(email, verify_url, subject, book):\n     context = {\n         'verification_url': verify_url,\n"
                },
                {
                    "date": 1725014612043,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,9 +306,9 @@\n \n def sendBookingConfirmationEMail(email, verify_url, subject, book):\n     context = {\n         'verification_url': verify_url,\n-        'recipient_name': 'Admin',  # Or the actual name of the admin or recipient\n+        'recipient_name': 'Admin',  \n         'contact': book.phone_number,  # Assuming `phone_number` is a field in `DestinationBook`\n         'activity': book.activity.name,  # Assuming `activity` is a ForeignKey to an `Activity` model\n         'package': book.package.name,  # Assuming `package` is a ForeignKey to a `Package` model\n         'destination': book.destination.destination_title,  # Assuming `destination` is a ForeignKey to a `Destination` model\n"
                },
                {
                    "date": 1725014617569,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -307,10 +307,10 @@\n def sendBookingConfirmationEMail(email, verify_url, subject, book):\n     context = {\n         'verification_url': verify_url,\n         'recipient_name': 'Admin',  \n-        'contact': book.phone_number,  # Assuming `phone_number` is a field in `DestinationBook`\n-        'activity': book.activity.name,  # Assuming `activity` is a ForeignKey to an `Activity` model\n+        'contact': book.phone_number, \n+        'activity': book.activity.name,  \n         'package': book.package.name,  # Assuming `package` is a ForeignKey to a `Package` model\n         'destination': book.destination.destination_title,  # Assuming `destination` is a ForeignKey to a `Destination` model\n         'arrival_date': book.arrival_date.strftime('%d/%m/%Y'),  # Format date as required\n         'departure_date': book.departure_date.strftime('%d/%m/%Y'),  # Format date as required\n"
                },
                {
                    "date": 1725014623576,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -309,10 +309,10 @@\n         'verification_url': verify_url,\n         'recipient_name': 'Admin',  \n         'contact': book.phone_number, \n         'activity': book.activity.name,  \n-        'package': book.package.name,  # Assuming `package` is a ForeignKey to a `Package` model\n-        'destination': book.destination.destination_title,  # Assuming `destination` is a ForeignKey to a `Destination` model\n+        'package': book.package.name,  \n+        'destination': book.destination.destination_title,  \n         'arrival_date': book.arrival_date.strftime('%d/%m/%Y'),  # Format date as required\n         'departure_date': book.departure_date.strftime('%d/%m/%Y'),  # Format date as required\n         'preferred_service_type': book.service_type,  # Assuming `service_type` is a field in `DestinationBook`\n     }\n"
                },
                {
                    "date": 1725014629055,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -311,10 +311,10 @@\n         'contact': book.phone_number, \n         'activity': book.activity.name,  \n         'package': book.package.name,  \n         'destination': book.destination.destination_title,  \n-        'arrival_date': book.arrival_date.strftime('%d/%m/%Y'),  # Format date as required\n-        'departure_date': book.departure_date.strftime('%d/%m/%Y'),  # Format date as required\n+        'arrival_date': book.arrival_date.strftime('%d/%m/%Y'),  \n+        'departure_date': book.departure_date.strftime('%d/%m/%Y'),  \n         'preferred_service_type': book.service_type,  # Assuming `service_type` is a field in `DestinationBook`\n     }\n     html_content = render_to_string('booking_notification_email.html', context)  # Template path\n     email_from = settings.EMAIL_HOST_USER\n"
                },
                {
                    "date": 1725014650215,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -313,9 +313,9 @@\n         'package': book.package.name,  \n         'destination': book.destination.destination_title,  \n         'arrival_date': book.arrival_date.strftime('%d/%m/%Y'),  \n         'departure_date': book.departure_date.strftime('%d/%m/%Y'),  \n-        'preferred_service_type': book.service_type,  # Assuming `service_type` is a field in `DestinationBook`\n+        'preferred_service_type': book.service_type, \n     }\n     html_content = render_to_string('booking_notification_email.html', context)  # Template path\n     email_from = settings.EMAIL_HOST_USER\n     recipient_list = [email]\n"
                },
                {
                    "date": 1725014678773,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,9 +306,9 @@\n \n def sendBookingConfirmationEMail(email, verify_url, subject, book):\n     context = {\n         'verification_url': verify_url,\n-        'recipient_name': 'Admin',  \n+        'recipient_name': 'full_name',  \n         'contact': book.phone_number, \n         'activity': book.activity.name,  \n         'package': book.package.name,  \n         'destination': book.destination.destination_title,  \n"
                },
                {
                    "date": 1725014684896,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,9 +306,9 @@\n \n def sendBookingConfirmationEMail(email, verify_url, subject, book):\n     context = {\n         'verification_url': verify_url,\n-        'recipient_name': 'full_name',  \n+        'recipient_name': 'book.full_name',  \n         'contact': book.phone_number, \n         'activity': book.activity.name,  \n         'package': book.package.name,  \n         'destination': book.destination.destination_title,  \n"
                }
            ],
            "date": 1725013363852,
            "name": "Commit-0",
            "content": "from django.shortcuts import render\nfrom rest_framework import generics, status, viewsets, response\nfrom .serializers import EmailNumberSerializer, CustomPasswordResetSerializer, TokenValidationSerializer,ContactMeSerializer,EmailResetSerializer,EmailChangeGetOtpSerializer\nfrom accounts.models import CustomUser\nfrom django.utils.http import urlsafe_base64_encode\nfrom django.utils.encoding import force_bytes\nfrom django.contrib.auth.tokens import PasswordResetTokenGenerator\nfrom django.urls import reverse\nfrom django.conf import settings\nfrom django.core.mail import send_mail\nfrom django.contrib.auth.hashers import check_password\n\n\nfrom rest_framework.views import APIView\nfrom rest_framework.response import Response\nfrom rest_framework import status\nfrom rest_framework_simplejwt.tokens import RefreshToken\nfrom .sms_sender import SendSms,ContactMe\nfrom django.db.models import Q\nfrom django.core.cache import cache\n\nimport random\nimport string\n\notp_time_expired = 1200\nsite_f  = \"https://lims.dftqc.gov.np\" #http://localhost:4200\"#\"https://dev-lims.netlify.app\"#\"https://lims.dftqc.gov.np\"\n\nclass EmailCheckView(generics.GenericAPIView):\n\n    def generate_otp(self,user):\n        # Generate a random 6-digit OTP\n        return '987654'\n        user = str(user)\n        return user[0]+''.join(random.choices(string.digits, k=4)) + user[-1]\n    \n    serializer_class = EmailNumberSerializer\n    def post(self, request):\n        serializer = self.serializer_class(data=request.data)\n        serializer.is_valid(raise_exception=True)\n        email = serializer.data[\"email\"]\n        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n        if user:\n        \n            otp = self.generate_otp(user.id)\n\n            reset_verification = \"reset_password\"\n            subject = 'lead-management OTP'\n            if '@' in email:\n                email = user.email\n                sendMail(email, otp,subject,reset_verification)\n            else:\n                SendSms(contact=email,otp=otp,message=subject)\n          \n            cache_key = f\"password_reset_otp_{user.id}\"\n        \n            cache.set(cache_key, otp, timeout=otp_time_expired)\n\n            return response.Response(\n                {\n                \"message\": \"otp has been sent to your email address\"\n                },\n                status=status.HTTP_200_OK,\n            )\n        else:\n            return response.Response(\n                {\"message\": \"User doesn't exists\"},\n                status=status.HTTP_400_BAD_REQUEST,\n            )\n        \nclass EmailChangeGetOtpView(generics.GenericAPIView):\n    def generate_otp(self,user):\n        # Generate a random 6-digit OTP\n        return \"123456\"\n        user = str(user)\n        return user[0]+''.join(random.choices(string.digits, k=4)) + user[-1]\n    \n    serializer_class = EmailChangeGetOtpSerializer\n    def post(self, request):\n        serializer = self.serializer_class(data=request.data)\n        serializer.is_valid(raise_exception=True)\n        email = serializer.data[\"email\"]\n        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n        if user:\n        \n            otp = self.generate_otp(user.id)\n\n            reset_verification = \"reset_email\"\n            subject = 'Pacific OTP'\n            if '@' in email:\n                email = user.email\n                sendMail(serializer.data[\"second_email\"], otp,subject,reset_verification)\n            else:\n                SendSms(contact=email,otp=otp,message=subject)\n          \n            cache_key = f\"email_reset_otp_{user.id}\"\n            cache.set(cache_key, otp, timeout=otp_time_expired)\n\n            return response.Response(\n                {\n                \"message\": f\"otp has been sent to your email address {serializer.data['second_email']} \"\n                },\n                status=status.HTTP_200_OK,\n            )\n        else:\n            return response.Response(\n                {\"message\": \"User doesn't exists\"},\n                status=status.HTTP_400_BAD_REQUEST,\n            )\n\nclass CustomPasswordResetView(generics.GenericAPIView):\n    serializer_class = CustomPasswordResetSerializer\n    \n    def post(self, request, *args, **kwargs):\n        serializer = self.serializer_class(data=request.data, context={\"kwargs\":kwargs})\n        serializer.is_valid(raise_exception=True)\n     \n        user = CustomUser.objects.get(Q(email = serializer.data.get('email')) | Q(phone = serializer.data.get('email')))\n        if serializer.validated_data.get('token_validate') == True:\n            user.password = serializer.data.get('password')\n            user.save()\n            message = \"Password Reset Complete\"\n            stat = status.HTTP_200_OK\n            print(\" password save \")\n        else:\n            message = \"Password Reset not Completed\"\n            stat = status.HTTP_400_BAD_REQUEST\n            print(\"password not save\")\n\n        return response.Response(\n            {\"message\": message},\n            status=stat,\n        )\n\nclass EmailResetView(generics.GenericAPIView):\n    serializer_class = EmailResetSerializer\n    \n    def post(self, request, *args, **kwargs):\n        serializer = self.serializer_class(data=request.data, context={\"kwargs\":kwargs})\n        serializer.is_valid(raise_exception=True)\n     \n        user = CustomUser.objects.get(Q(email = serializer.data.get('email')))\n        if not check_password(serializer.data.get('password'),user.password):\n            message = \"password does not match\"\n            stat = status.HTTP_200_OK\n        if serializer.validated_data.get('token_validate') == True:\n            print(\"validate  data\")\n            user.email = serializer.data.get('second_email')\n            user.save()\n            message = \"Email Reset Complete\"\n            stat = status.HTTP_200_OK\n            print(\" Email Reset save \")\n        else:\n            message = \"Email Can Not reset\"\n            stat = status.HTTP_400_BAD_REQUEST\n            print(\"Email Reset not save\")\n\n        return response.Response(\n            {\"message\": message},\n            status=stat,\n        )\n    \n\nclass VerifyUserPasswordToken(generics.GenericAPIView):\n    serializer_class = TokenValidationSerializer\n    \n    def post(self, request, *args, **kwargs):\n        serializer = self.serializer_class(data=request.data, context={\"kwargs\":kwargs})\n        serializer.is_valid(raise_exception=True)\n        \n        return response.Response(\n            {\"message\": \"Your Token is Validate\",\n             'data' : serializer.data,\n            },\n            status=status.HTTP_200_OK,\n        )\n\n\nclass SendEmailVerificationLink(APIView):\n    \n    def post(self, request, *args, **kwargs):\n        email = request.data.get('email')\n        user = CustomUser.objects.filter(email=email).first()\n\n        try:\n            user = CustomUser.objects.get(email=email)\n        except CustomUser.DoesNotExist:\n            return Response({\n                'detail': 'User with this email does not exist.',\n            }, status=status.HTTP_400_BAD_REQUEST)\n\n        encoded_pk = urlsafe_base64_encode(force_bytes(user.pk))\n        token = PasswordResetTokenGenerator().make_token(user)\n\n        # Send the token via email\n        subject = 'Email Verification Token'\n        verify_url = f\"{site_f}/user-verification-success?pk={encoded_pk}&token={token}\"\n        subject = 'Email Verification Link '\n        reset_verification = \"verification\"\n        sendMail(email,verify_url,subject,reset_verification)\n\n        return Response({\n            'detail': 'Email verificatio'})\n\ndef sendMail(email, reset_url,subject,reset_verification):\n    if reset_verification == \"verification\":\n        body = f\"\"\"<body>\n            <table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"max-width: 600px; font-family: Poppins; background: whitesmoke; padding: 20px; border-radius: 6px;\">\n                <tr>\n                    <td align=\"center\" bgcolor=\"#FFFFFF\" style=\"padding: 20px;\">\n                        <img src=\"https://lead-management.com.np/assets/logo-Ds_vvW8g.png\" alt=\"\" width=\"132\" style=\"display: block; margin: 0 auto;\">\n                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">lead-management</p>\n                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">Please verify your account</p>\n                        <p style=\"text-align: center; font-weight: 400;\">Click the button below to verify your account.</p>\n                        <a href=\"{reset_url}\" style=\"text-decoration: none; background: #0B53A7; color: #FFFFFF; padding: 10px 20px; border-radius: 3px; display: inline-block; margin-top: 15px;\">Verify Your Account</a>\n                        <p style=\"text-align: center; margin-top: 20px;\">Please visit <a href=\"https://lead-management.com.np/\" style=\"text-decoration: none; color: #0B53A7; font-weight: 600;\">https://lead-management.com.np/</a> for any enquiries.</p>\n                        <p style=\"margin: 0; text-align: center;\"><span style=\"font-weight: 600;\">Tel:</span>+977 97798000000</p>\n                        <p style=\"margin: 0; text-align: center; text-decoration: none;\"><span style=\"font-weight: 600;\">Fax:</span>+97798000000 <span style=\"font-weight: 600; margin-left: 10px;\">E-mail:</span> info@lead-management.com</p>\n                    </td>\n                </tr>\n            </table>\n        </body>\n        </html>\"\"\"\n    else:\n        body = f\"\"\"<body>\n            <table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"max-width: 600px; font-family: Poppins; background: whitesmoke; padding: 20px; border-radius: 6px;\">\n                <tr>\n                    <td align=\"center\" bgcolor=\"#FFFFFF\" style=\"padding: 20px;\">\n                        <img src=\"https://lead-management.com.np/assets/logo-Ds_vvW8g.png\" alt=\"\" width=\"132\" style=\"display: block; margin: 0 auto;\">\n                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">lead-management</p>\n                        <p style=\"color: #0B53A7; font-weight: 600; font-size: 18px; margin-top: 20px;\">Please change your Password</p>\n                        <p style=\"text-align: center; font-weight: 400;\">Your OTP code to reset password is</p>\n                        <span style=\"text-decoration: none; background: #0B53A7; color: #FFFFFF; padding: 10px 20px; border-radius: 3px; display: inline-block; margin-top: 15px;\">{reset_url}</span>\n                        <p style=\"text-align: center; margin-top: 20px;\">Please visit <a href=\"https://lead-management.com.np/\" style=\"text-decoration: none; color: #0B53A7; font-weight: 600;\">https://lead-management.com.np</a> for any enquiries.</p>\n                        <p style=\"margin: 0; text-align: center;\"><span style=\"font-weight: 600;\">Tel:</span> 01-5244366</p>\n                        <p style=\"margin: 0; text-align: center; text-decoration: none;\"><span style=\"font-weight: 600;\">Phone:</span> +977 9802348565 <span style=\"font-weight: 600; margin-left: 10px;\">E-mail:</span> support@lead-management.com</p>\n                    </td>\n                </tr>\n            </table>\n        </body>\n        </html>\"\"\"\n    html_contents = \"\"\"<!DOCTYPE html>\n        <html lang=\"en\">\n        <head>\n            <meta charset=\"UTF-8\">\n            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            <title>Email Template</title>\n            <style>\n                @import url(\"https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap\");\n            </style>\n        </head>\"\"\" + body\n    \n    email_from = settings.EMAIL_HOST_USER\n    recipient_list = [email]\n    plain_message = \"\"\n    send_mail(subject, plain_message, email_from, recipient_list,html_message=html_contents)\n\n\nclass ContactmeView(generics.GenericAPIView):    \n    serializer_class = ContactMeSerializer\n    def post(self, request):\n        serializer = self.serializer_class(data=request.data)\n        serializer.is_valid(raise_exception=True)\n\n        email = serializer.data[\"email\"]\n        subject = serializer.data.get('subject')\n        full_name = serializer.data[\"full_name\"]\n        message = serializer.data[\"message\"]\n        phone = serializer.data.get(\"phone\")\n        \n        ContactMe(email,phone,full_name,subject,message)\n           \n        return response.Response(\n            {\n            \"message\": \"Email has sent to lead-management Owner, please kindly wait for response\"\n            },\n            status=status.HTTP_200_OK,\n        )\n     \n    class SendEmailForBookingVerification(APIView):\n    serializer_class = EmailNumberSerializer\n\n    def post(self, request, *args, **kwargs):\n        serializer = self.serializer_class(data=request.data)\n        if serializer.is_valid():\n            email = serializer.validated_data[\"email\"]\n            try:\n                book = BookManagement.objects.get(email=email)\n                print(\"services\",book.services.service_name)\n            except BookManagement.DoesNotExist:\n                return Response({'detail': 'Booking details with this email do not exist.'}, status=status.HTTP_400_BAD_REQUEST)\n\n            # Construct the verification URL\n            site_url = 'https://example.com'  # Replace with your actual site URL\n            verify_url = f\"{site_url}/user-verification-success?pk={urlsafe_base64_encode(force_bytes(book.pk))}\"\n\n            # Send the confirmation email\n            subject = 'Booking Verification Email'\n            sendBookingConfirmationEMail(email, verify_url, subject, book)\n\n            return Response({'detail': 'Email verification sent successfully'})\n        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)\n\ndef sendBookingConfirmationEMail(email, verify_url, subject, book):\n    context = {\n        'verification_url': verify_url,\n        'book': book,\n    }\n\n    html_content = render_to_string('booking_confirmation.html', context)\n\n    email_from = settings.EMAIL_HOST_USER\n    recipient_list = [email]\n    plain_message = \"\"\n\n    send_mail(subject, plain_message, email_from, recipient_list, html_message=html_content)\n    \n\nclass PasswordResetView(generics.GenericAPIView):\n\n    def generate_otp(self,user):\n        # Generate a random 6-digit OTP\n        # return \"123456\"\n        user = str(user)\n        return user[0]+''.join(random.choices(string.digits, k=3)) + user[-1]\n    \n    serializer_class = PasswordNumberSerializer\n    def post(self, request):\n        serializer = self.serializer_class(data=request.data)\n        serializer.is_valid(raise_exception=True)\n        email = serializer.data[\"email\"]\n        user = CustomUser.objects.filter(Q(email=email) | Q(phone = email)).first()\n        if user:\n        \n            otp = self.generate_otp(user.id)\n\n            email_type = \"reset_password\"\n            \n            subject = 'LifeQuest OTP'\n            if '@' in email:\n                email = user.email\n                sendPasswordResetMail(email, otp,subject,email_type,user)\n            else:\n                SendSms(contact=email,otp=otp,message=subject)\n          \n            cache_key = f\"password_reset_otp_{user.id}\"\n            cache.set(cache_key, otp, timeout=otp_time_expired)\n\n            return response.Response(\n                {\n                \"message\":\"OTP has been sent to your email address\"\n                },\n                status=status.HTTP_200_OK,\n            )\n        else:\n            return response.Response(\n                {\"message\": \"User doesn't exists\"},\n                status=status.HTTP_400_BAD_REQUEST,\n            )\n\ndef sendPasswordResetMail(email, otp, subject, email_type, user):\n    password_html_contents = \"\"  # Initialize to avoid UnboundLocalError\n    \n    if email_type == \"reset_password\":  # Ensure this matches what is passed\n        context = {\n            'otp': otp,\n            'user': user,\n            'verification_url': 'https://example.com/verify'\n        }\n        \n        password_html_contents = render_to_string('forget_password_get_otp.html', context)\n    \n    email_from = settings.EMAIL_HOST_USER\n    recipient_list = [email]\n    plain_message = \"\"\n    send_mail(subject, plain_message, email_from, recipient_list, html_message=password_html_contents)"
        }
    ]
}